ALTER TABLE LDB1_MAINT_TASKS DROP COLUMN FREF_TYPE;
ALTER TABLE LDB1_MAINT_TASKSPPE DROP COLUMN FREF_TYPE;
ALTER TABLE LDB1_MAINT_TASKSTOOLS DROP COLUMN FREF_TYPE;
ALTER TABLE LDB1_MAINT_TASKSPARAM DROP COLUMN FREF_TYPE;


ALTER TABLE LDB1_MAINT_TASKS ADD (FSTATUS CHAR(1) DEFAULT 'A');

ALTER TABLE LDB1_MAINT_TASKSPPE ADD (FSTATUS CHAR(1) DEFAULT 'A',FUPDATEDON	NUMBER(8,0) DEFAULT 0 NOT NULL,
	FUPDATEDTIME 	NUMBER(6,0) DEFAULT 0 NOT NULL,
	FUPDATEDBY 	NUMBER(10,0) DEFAULT NULL);  
  
ALTER TABLE LDB1_MAINT_TASKSTOOLS ADD (FSTATUS CHAR(1) DEFAULT 'A',FUPDATEDON	NUMBER(8,0) DEFAULT 0 NOT NULL,
	FUPDATEDTIME 	NUMBER(6,0) DEFAULT 0 NOT NULL,
	FUPDATEDBY 	NUMBER(10,0) DEFAULT NULL);
  
ALTER TABLE LDB1_MAINT_TASKSPARAM ADD (FSTATUS CHAR(1) DEFAULT 'A');


ALTER TABLE LDB1_MAINT_TASKGROUP DROP COLUMN FREF_TYPE;
ALTER TABLE LDB1_MAINT_TASKGROUP ADD (FREF_TYPE VARCHAR2(30) DEFAULT 'TASK');
ALTER TABLE LDB1_MAINT_TASKGROUP MODIFY (FREF_TYPE VARCHAR2(30) NOT NULL);
UPDATE LDB1_MAINT_TASKGROUP SET FREF_TYPE='SCHEDULE' WHERE FTASKGROUPNAME='MANUAL_TASK';
COMMIT;

--------------------------------------------Changes Master enum value----------------------
UPDATE LDB1_MAINT_MASTER SET FDTYPE='TYPE' WHERE FTYPE='T';
UPDATE LDB1_MAINT_MASTER SET FDTYPE='CLASS' WHERE FTYPE='C';
UPDATE LDB1_MAINT_MASTER SET FDTYPE='MP_CATEGORY' WHERE FTYPE='P';
UPDATE LDB1_MAINT_MASTER SET FDTYPE='GROUPCODE' WHERE FTYPE='G';
UPDATE LDB1_MAINT_MASTER SET FDTYPE='TASKGRP_TYPE' WHERE FTYPE='S';
UPDATE LDB1_MAINT_MASTER SET FDTYPE='MAINT_TYPE' WHERE FTYPE='A';
UPDATE LDB1_MAINT_MASTER SET FDTYPE='PRIORITY' WHERE FTYPE='R';
UPDATE LDB1_MAINT_MASTER SET FDTYPE='WORKGROUP' WHERE FTYPE='W';

DROP INDEX INDX_MAINTMASTERTYPE;

ALTER TABLE LDB1_MAINT_MASTER DROP UNUSED COLUMNS;
ALTER TABLE LDB1_MAINT_MASTER DROP COLUMN FTYPE;
ALTER TABLE LDB1_MAINT_MASTER RENAME COLUMN FDTYPE TO FTYPE;

CREATE INDEX INDX_MAINTMASTERTYPE ON LDB1_MAINT_MASTER(FSITEID,FTYPE,UPPER(FNAME));
COMMIT;
-----------------------------------------------------------------------------------------------------------


--Views
==========================================

CREATE OR REPLACE VIEW VW_MAINT_MANAGESCHEDULE AS
SELECT S.FSITEID,S.FSCHEDULEID,S.FMAINTENANCENAME,S.FMAINDESCRIPTION,DECODE(ME.FEQUIPMENTNAME,NULL,ML.FLOCATIONNAME,ME.FEQUIPMENTNAME) AS FEQUIPORLOCATION
,M1.FNAME AS FMAINTTYPE,S.FPRIORITYTYPE AS FPRIORITY,M3.FNAME AS FWORKGROUP,S.FSCHEDULESTATUS,S.FSCHD_RULE_DESC_TYPE,S.FSCHD_RULE_DESC
,(SELECT LISTAGG(TO_CHAR(TRIM(U.FLASTNAME || ' ' || U.FFIRSTNAME)),', ') WITHIN GROUP (ORDER BY U.FFIRSTNAME) FROM LDB1_MAINT_WORKGROUPUSER MU INNER JOIN LDB1_USERINFO U ON MU.FSITEID=S.FSITEID AND U.FUSERID=MU.FUSERID
WHERE MU.FWORKGROUPID=S.FWORKGROUPID AND MU.FUSERTYPE='A') AS FASSIGNEE
,(SELECT LISTAGG(TO_CHAR(TRIM(U.FLASTNAME || ' ' || U.FFIRSTNAME)),', ') WITHIN GROUP (ORDER BY U.FFIRSTNAME) FROM LDB1_MAINT_WORKGROUPUSER MU INNER JOIN LDB1_USERINFO U ON MU.FSITEID=S.FSITEID AND U.FUSERID=MU.FUSERID
WHERE MU.FWORKGROUPID=S.FWORKGROUPID AND MU.FUSERTYPE='R') AS FREPORTEDTO
,(SELECT ROUND(SUM(MT.FESTIMATEDTIME)/60,2) FROM LDB1_MAINT_TASKGROUP TG INNER JOIN LDB1_MAINT_TASKS MT ON MT.FREFERENCEID=TG.FTASKGROUPID WHERE TG.FIDENTIFIER=S.FTASKGROUPIDENTIFIER AND TG.FSITEID=S.FSITEID AND TG.FSTATUS='A') AS FESTIMATEDTIME
,(SELECT MIN(TO_NUMBER(TO_CHAR(FSCHEDULEDATE || '' || LPAD(FSCHEDULETIME,6,'0')))) FROM LDB1_MAINT_WORKORDER W WHERE W.FREF_SCHEDULEID=S.FSCHEDULEID AND W.FSITEID=S.FSITEID AND W.FSTATUS='S') AS FNEXTDUEDATE
,(SELECT MAX(TO_NUMBER(TO_CHAR(FSCHEDULEDATE || '' || LPAD(FSCHEDULETIME,6,'0')))) FROM LDB1_MAINT_WORKORDER W WHERE W.FREF_SCHEDULEID=S.FSCHEDULEID AND W.FSITEID=S.FSITEID AND W.FSTATUS='S') AS FLASTDUEDATE
,SD.FSCHEDULE_DTL_ID,S.FSCHEDULESTATUS AS FSCHEDULESTATUSVALUE
FROM LDB1_MAINT_SCHEDULE S
INNER JOIN LDB1_MAINT_MASTER M1 ON M1.FMASTERID=S.FMAINTYPEID AND M1.FSITEID=S.FSITEID AND M1.FTYPE='MAINT_TYPE'
INNER JOIN LDB1_MAINT_MASTER M3 ON M3.FMASTERID=S.FWORKGROUPID AND M3.FSITEID=S.FSITEID AND M3.FTYPE='WORKGROUP'
LEFT OUTER JOIN LDB1_MAINT_LOCATIONS ML ON ML.FSITEID=S.FSITEID AND ML.FLOCATIONID=S.FLOCATIONID
LEFT OUTER JOIN LDB1_MAINT_EQUIPMENT ME ON ME.FSITEID=S.FSITEID AND ME.FEQUIPMENTID=S.FEQUIPMENTID
LEFT OUTER JOIN LDB1_MAINT_SCHEDULE_DTL SD ON SD.FSCHEDULEID=S.FSCHEDULEID AND SD.FITEM_ID=1 AND SD.FSTATUS='A'
WHERE S.FSCHEDULE_TYPE='S' AND S.FSTATUS='A'
ORDER BY S.FTIMESTAMP DESC;



-----------------------------------------------------------------------

CREATE OR REPLACE VIEW VW_MAINT_MANAGEWORKORDER AS
SELECT S.FSITEID,S.FSCHEDULEID,S.FMAINTENANCENAME,DECODE(ME.FEQUIPMENTNAME,NULL,ML.FLOCATIONNAME,ME.FEQUIPMENTNAME) AS FEQUIPORLOCATION
,M1.FNAME AS FMAINTTYPE,S.FPRIORITYTYPE AS FPRIORITY,M3.FNAME AS FWORKGROUP
,(SELECT LISTAGG(TO_CHAR(TRIM(U.FLASTNAME || ' ' || U.FFIRSTNAME)),', ') WITHIN GROUP (ORDER BY U.FFIRSTNAME) FROM LDB1_MAINT_WORKGROUPUSER MU INNER JOIN LDB1_USERINFO U ON MU.FSITEID=S.FSITEID AND U.FUSERID=MU.FUSERID
WHERE MU.FWORKGROUPID=S.FWORKGROUPID AND MU.FUSERTYPE='A') AS FASSIGNEE
,(SELECT LISTAGG(TO_CHAR(TRIM(U.FLASTNAME || ' ' || U.FFIRSTNAME)),', ') WITHIN GROUP (ORDER BY U.FFIRSTNAME) FROM LDB1_MAINT_WORKGROUPUSER MU INNER JOIN LDB1_USERINFO U ON MU.FSITEID=S.FSITEID AND U.FUSERID=MU.FUSERID
WHERE MU.FWORKGROUPID=S.FWORKGROUPID AND MU.FUSERTYPE='R') AS FREPORTEDTO
,(SELECT ROUND(SUM(MT.FESTIMATEDTIME)/60,2) FROM LDB1_MAINT_TASKGROUP TG INNER JOIN LDB1_MAINT_TASKS MT ON MT.FREFERENCEID=TG.FTASKGROUPID WHERE TG.FIDENTIFIER=S.FTASKGROUPIDENTIFIER AND TG.FSITEID=S.FSITEID AND TG.FSTATUS='A') AS FESTIMATEDTIME
,MW.FSTATUS,MW.FSTATUS AS FSTATUSKEY,LTRIM(MW.FWORK_ORDERID,'0') AS FWORK_ORDERID,MW.FSCHEDULEDATE,MW.FSCHEDULETIME,MW.FPLANNEDDATE,MW.FPLANNEDTIME
FROM LDB1_MAINT_SCHEDULE S
INNER JOIN LDB1_MAINT_MASTER M1 ON M1.FMASTERID=S.FMAINTYPEID AND M1.FSITEID=S.FSITEID AND M1.FTYPE='MAINT_TYPE'
INNER JOIN LDB1_MAINT_MASTER M3 ON M3.FMASTERID=S.FWORKGROUPID AND M3.FSITEID=S.FSITEID AND M3.FTYPE='WORKGROUP'
INNER JOIN LDB1_MAINT_WORKORDER MW ON MW.FREF_SCHEDULEID=S.FSCHEDULEID
LEFT OUTER JOIN LDB1_MAINT_LOCATIONS ML ON ML.FSITEID=S.FSITEID AND ML.FLOCATIONID=S.FLOCATIONID
LEFT OUTER JOIN LDB1_MAINT_EQUIPMENT ME ON ME.FSITEID=S.FSITEID AND ME.FEQUIPMENTID=S.FEQUIPMENTID
WHERE S.FSCHEDULE_TYPE='W' AND S.FSTATUS='A'
ORDER BY S.FTIMESTAMP DESC;





----------------------------------------------------------------------

CREATE OR REPLACE  VIEW VW_MAINT_MEASURING_POINT AS 
SELECT MP.FSITEID,MP.FMEASURINGPOINTID,MP.FMEASURINGPOINTCODE,MP.FMEASURINGPOINTNAME,MP.FDESCRIPTION,MP.FPOSITION,C.FNAME AS FCATEGORY,SU.FUOMNAME AS FUNIT
  ,DECODE(ML.FLOCATIONNAME,'','None',ML.FLOCATIONNAME) AS FLOCATIONNAME
  ,DECODE(ME.FEQUIPMENTNAME,'','None',ME.FEQUIPMENTNAME) AS FEQUIPMENTNAME
  ,CASE MP.FREADINGTYPE WHEN 'T' THEN 'Text' WHEN 'D' THEN 'Decimal' WHEN 'N' THEN 'Numeric'  WHEN 'S' THEN 'Selection' END AS FREADINGTYPE
  ,CASE MP.FSTATUS WHEN 'A' THEN 'Active' WHEN 'N' THEN 'Not Active' END AS FSTATUS
  ,MP.FLOWERLIMIT,MP.FUPPERLIMIT,MP.FLOWERLIMITWARNING,MP.FUPPERLIMITWARNING,MP.FMAXTEXTLENGTH
FROM LDB1_MAINT_MEASURINGPOINT MP
INNER JOIN LDB1_MAINT_MASTER C ON C.FMASTERID=MP.FCATEGORYID AND C.FSITEID=MP.FSITEID AND C.FSTATUS='A' AND C.FTYPE='MP_CATEGORY'
LEFT OUTER JOIN LDB1_SENSORTYPE_UOM SU ON SU.FSENSORTYPEUOMID=MP.FSENSORTYPEUOMID
LEFT OUTER JOIN LDB1_MAINT_LOCATIONS ML ON ML.FLOCATIONID=MP.FPARENTID AND MP.FPARENTTYPE='L'
LEFT OUTER JOIN LDB1_MAINT_EQUIPMENT ME ON ME.FEQUIPMENTID=MP.FPARENTID AND MP.FPARENTTYPE='E'
WHERE MP.FSTATUS<>'I' AND MP.FPARENTTYPE<>'M' ORDER BY MP.FUPDATEDON||MP.FUPDATEDTIME DESC;




----------------------------------------------------------------------

CREATE OR REPLACE VIEW VW_MAINT_EQUIPMENTMODEL AS  
SELECT E.FSITEID,E.FEQUIPMENTID,E.FEQUIPMENTNAME,E.FDESCRIPTION,E.FMODELNUMBER,NVL(E.FIMAGENAME,'0') AS FIMAGENAME,
M.FNAME AS FMANUFACTURERNAME,T.FNAME AS FCATEGORYNAME,C.FNAME AS FCLASSNAME FROM LDB1_MAINT_EQUIPMENT E 
INNER JOIN LDB1_MAINT_MASTER M ON M.FMASTERID=E.FMANUFID AND M.FSITEID=E.FSITEID AND M.FTYPE='MANUFACTURER'  
INNER JOIN LDB1_MAINT_MASTER T ON T.FMASTERID=E.FCATEGORYID AND T.FSITEID=E.FSITEID AND T.FTYPE='TYPE' 
INNER JOIN LDB1_MAINT_MASTER C ON C.FMASTERID=E.FCLASSID AND C.FSITEID=E.FSITEID AND C.FTYPE='CLASS'  
WHERE E.FINFOTYPE='M' AND E.FSTATUS='A' 
ORDER BY E.FUPDATEDON DESC, E.FUPDATEDTIME DESC;





---------------------------------------------------------------------

CREATE OR REPLACE VIEW VW_MAINT_TASKGROUPMODEL AS  
SELECT T.FIDENTIFIER, T.FSITEID,T.FTASKGROUPID,T.FTASKGROUPNAME,M.FNAME AS FTASKGROUPTYPE,T.FVERSION,
T.FSTATUS,T.FUPDATEDON,U.FUSERNAME,
(SELECT COUNT(FTASKID) FROM LDB1_MAINT_TASKS WHERE FREFERENCEID=T.FTASKGROUPID  AND FSITEID=T.FSITEID AND FSTATUS='A') AS FTOTALTASK,
(SELECT  ROUND(NVL(SUM(FESTIMATEDTIME),0)/60) FROM LDB1_MAINT_TASKS WHERE FREFERENCEID=T.FTASKGROUPID  AND FSITEID=T.FSITEID AND FSTATUS='A') AS FTOTALTIME,
NVL((SELECT P.FVERSION FROM LDB1_MAINT_TASKGROUP P WHERE P.FIDENTIFIER =T.FIDENTIFIER AND P.FSTATUS='A'),0) AS APPROVEDVERSION
 FROM LDB1_MAINT_TASKGROUP T  
 LEFT OUTER JOIN LDB1_USERINFO U ON U.FUSERID=T.FUPDATEDBY 
 LEFT OUTER JOIN LDB1_MAINT_MASTER M ON T.FTASKGROUPTYPEID= M.FMASTERID AND M.FTYPE='TASKGRP_TYPE' AND M.FSITEID=T.FSITEID AND M.FSTATUS='A'
 WHERE T.FSITEID=T.FSITEID AND T.FSTATUS<>'I' AND T.FREF_TYPE='TASK'
 AND T.FUPDATEDON = (SELECT MAX(FUPDATEDON) FROM LDB1_MAINT_TASKGROUP WHERE FIDENTIFIER=T.FIDENTIFIER AND FSITEID =T.FSITEID AND FSTATUS<>'I')
 AND T.FUPDATEDTIME = (SELECT MAX(FUPDATEDTIME) FROM LDB1_MAINT_TASKGROUP WHERE FIDENTIFIER=T.FIDENTIFIER AND FUPDATEDON=T.FUPDATEDON AND FSITEID =T.FSITEID AND FSTATUS<>'I' )
 ORDER BY T.FUPDATEDON DESC,T.FUPDATEDTIME DESC;


-----------------------------------------------------------------------
Balram changes

--Table Alter
===========================
UPDATE LDB1_TASKS SET FTASKNAME='Manage Preventive Maintenance Schedule' WHERE FIDNUM = 10011;
ALTER TABLE LDB1_MAINT_SCHEDULE DROP COLUMN FPRIORITYID;
ALTER TABLE LDB1_MAINT_SCHEDULE ADD FPRIORITYTYPE VARCHAR2(20 BYTE);
DELETE FROM LDB1_MAINT_MASTER WHERE FTYPE='R';
ALTER TABLE LDB1_MAINT_SCHEDULE MODIFY FSCHEDULESTATUS CHAR(1 BYTE) DEFAULT 'N' --(N-Created,A-Released,I-Cancelled,P-Scheduling)


--Enum Configuration
==========================
INSERT INTO LDB1_ENUMTYPE(FTYPE,FVALUE,FTEXT) VALUES ('MAINT_PRIORITY_TYPE','HIGHEST','Highest');
INSERT INTO LDB1_ENUMTYPE(FTYPE,FVALUE,FTEXT) VALUES ('MAINT_PRIORITY_TYPE','HIGH','High');
INSERT INTO LDB1_ENUMTYPE(FTYPE,FVALUE,FTEXT) VALUES ('MAINT_PRIORITY_TYPE','MEDIUM','Medium');
INSERT INTO LDB1_ENUMTYPE(FTYPE,FVALUE,FTEXT) VALUES ('MAINT_PRIORITY_TYPE','LOW','Low');
INSERT INTO LDB1_ENUMTYPE(FTYPE,FVALUE,FTEXT) VALUES ('MAINT_PRIORITY_TYPE','LOWEST','Lowest');

INSERT INTO LDB1_ENUMTYPE(FTYPE,FVALUE,FTEXT) VALUES ('MAINT_SCHEDULESTATUS','N','Created');

-------Enum change
UPDATE LDB1_ENUMTYPE SET FTEXT='Cancelled' WHERE FTYPE='MAINT_SCHEDULESTATUS' AND FVALUE='I';
UPDATE LDB1_ENUMTYPE SET FTEXT='Released' WHERE FTYPE='MAINT_SCHEDULESTATUS' AND FVALUE='A';





----Task Scripts
==========================================================

INSERT INTO LDB1_TASKS(FTASKID,FACCESSLEVELID,FTASKNAME,FIDNUM,FISMASTERDATA,FSTATUS,FCATEGORY)
  VALUES(SEQUENCE_TASK_ID.NEXTVAL,1,'Configure Maintenance Type',10018,'M','A','Maintenance');
  
INSERT INTO LDB1_TASKS(FTASKID,FACCESSLEVELID,FTASKNAME,FIDNUM,FISMASTERDATA,FSTATUS,FCATEGORY)
  VALUES(SEQUENCE_TASK_ID.NEXTVAL,2,'Configure Maintenance Type',10018,'M','A','Maintenance');
  
INSERT INTO LDB1_TASKS(FTASKID,FACCESSLEVELID,FTASKNAME,FIDNUM,FISMASTERDATA,FSTATUS,FCATEGORY)
  VALUES(SEQUENCE_TASK_ID.NEXTVAL,3,'Configure Maintenance Type',10018,'M','A','Maintenance');
  
INSERT INTO LDB1_TASKS(FTASKID,FACCESSLEVELID,FTASKNAME,FIDNUM,FISMASTERDATA,FSTATUS,FCATEGORY)
  VALUES(SEQUENCE_TASK_ID.NEXTVAL,4,'Configure Maintenance Type',10018,'M','A','Maintenance');
  
INSERT INTO LDB1_TASKS(FTASKID,FACCESSLEVELID,FTASKNAME,FIDNUM,FISMASTERDATA,FSTATUS,FCATEGORY)
  VALUES(SEQUENCE_TASK_ID.NEXTVAL,5,'Configure Maintenance Type',10018,'M','A','Maintenance');


krupa
---------------------
ALTER TABLE
   LDB1_MAINT_WORKGROUPUSER
MODIFY
( 
   FUSERID    NUMBER(6,0),
   FSITEID NUMBER(8,0)
);
